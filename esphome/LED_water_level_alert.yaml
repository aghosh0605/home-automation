esphome:
  name: dinning-info
  friendly_name: Dining Info

esp8266:
  board: esp01_1m

# Enable logging Default: DEBUG
logger:

# Enable Home Assistant API
api:
  encryption:
    key: "Automatically Generated by ESPHome while setting up for first time"

ota:
  platform: esphome
  password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

sensor:
  # Check wifi strength in Home Assistant Dashboard
  - platform: wifi_signal
    name: WIFI_Signal
    update_interval: 600s
    unit_of_measurement: "%"
    filters:
      - lambda: |-
          if (x <= -100) {
            return 0;
          } else if (x >= -50) {
            return 100;
          } else {
            return 2 * (x + 100);
          }

# LEDs to show the status of the water level. Less than 20% Red, 20-85% Blue, 85-100% Green(Configured in automations)
light:
  - platform: status_led
    name: "Red"
    pin: GPIO5
  - platform: status_led
    name: "Green"
    pin: GPIO14
  - platform: status_led
    name: "Blue"
    pin: GPIO12

# Buzzer to alert when water level is above 95%(Configured in automations)
output:
  - platform: esp8266_pwm
    pin: GPIO15
    id: rtttl_out

rtttl:
  output: rtttl_out
  gain: 95% # Set the volume to 95% for the buzzer
  on_finished_playback:
    - logger.log: "Stopped Speaker!"

switch:
  - platform: template
    name: "Buzzer Alert"
    icon: "mdi:bullhorn-outline"
    id: buzzer_on_switch
    turn_on_action:
      - while:
          condition:
            - lambda: "return true;"
          then:
            - rtttl.play: "siren:d=8,o=5,b=100:d,e,d,e,d,e,d,e,d,e,d,e,d,e,d,e,d,e,d,e,d,e,d,e"
            - delay: 5s # add delay here, the old rtttl.play should end before the new starts
    turn_off_action:
      - rtttl.stop

# A binary sensor to turn off the buzzer when the button is pressed, connected to GPIO13
binary_sensor:
  - platform: gpio
    pin:
      number: GPIO13
      mode:
        input: true
        pullup: true

    name: "Buzzer Switch"
    on_press:
      then:
        - switch.turn_off: buzzer_on_switch
        - rtttl.stop
