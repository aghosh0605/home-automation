esphome:
  name: water-tank
  friendly_name: water_tank

esp8266:
  board: esp01_1m

# Enable logging Default: DEBUG
logger:

# Enable Home Assistant API
api:
  encryption:
    key: "Automatically Generated by ESPHome while setting up for first time"

ota:
  platform: esphome
  password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

sensor:
  # Check wifi strength in Home Assistant Dashboard
  - platform: wifi_signal
    name: water_tank_wifi
    update_interval: 600s
    unit_of_measurement: "%"
    filters:
      - lambda: |-
          if (x <= -100) {
            return 0;
          } else {
            if (x >= -50) {
              return 100;
            } else {
              return 2 * (x + 100);
            }
          }

  # Templates for calculated liter & percent
  - platform: template
    name: "Water Volume"
    id: watertank_liter
    icon: "mdi:water"
    unit_of_measurement: "l"
    accuracy_decimals: 2
    update_interval: 5s

  - platform: template
    name: "Water Percent"
    id: watertank_percent
    icon: "mdi:water-percent"
    unit_of_measurement: "%"
    accuracy_decimals: 2
    update_interval: 5s

  # Below values are for my 1000 litres water tank. It may vary for your tank. Empty and full values are taken after monitoring for some days.
  # Height of tank 122.5 cm -> 122cm round off
  # Perimeter of tank 350 cm -> 55.70 cm radius -> 11.40 diameter -> 9748.24 (cm)2
  # When tank is empty 1.05 m -> When tank is full .10 m
  # On average 1 min will change 6% while motor running. So, 95% can be trigger point as senor is running in every 5 sec.
  # 1 cm means to 0.9% of the tank according to 1.12m

  - platform: ultrasonic
    trigger_pin: GPIO5
    echo_pin: GPIO4
    name: "Water Level"
    update_interval: 5s
    pulse_time: 10us
    accuracy_decimals: 2
    timeout: 2.0m
    filters:
      - filter_out: nan
      - median:
          window_size: 7
          send_every: 4
          send_first_at: 3
      # - calibrate_linear:
      #     - 0.10 -> 1.12
      #     - 1.10 -> 0.0
    on_value:
      then:
        - sensor.template.publish:
            id: watertank_liter
            state: !lambda "return (1.12-x) * 974.824;"

        - sensor.template.publish:
            id: watertank_percent
            state: !lambda "return ((1.12-x) * 974.824 / 1000 ) * 100;"

  # DS18B20 sensor for water temperature detection inside the tank
  - platform: dallas_temp
    address: 0x163ce10457368928
    name: "Water Temperature"

one_wire:
  - platform: gpio
    pin: GPIO12
